---
slug: /timings
title: Timings
description: 如何使用 Paper 的 Timings 报告分析服务器性能。
---

# Timings 报告

Timings 报告是 Paper 和 Spigot 提供的一项强大的性能分析工具，可以帮助您了解服务器的性能瓶颈，找出导致服务器卡顿或 TPS 下降的原因。Timings 报告会记录服务器在一段时间内的各种性能数据，例如 Tick 耗时、插件耗时、方块实体耗时、实体耗时等，并将这些数据以 Web 页面的形式呈现出来，方便您进行分析。

## 生成 Timings 报告

您可以使用以下命令生成 Timings 报告：

*   `/paper timings report` 或 `/timings report`:  生成 Timings 报告，并将报告内容输出到服务器日志和控制台。
*   `/paper timings paste` 或 `/timings paste`:  生成 Timings 报告，并将报告内容上传到 [Aikar's Timings Viewer](https://timings.aikar.co/) 网站，并返回一个 URL 链接，您可以通过该链接在线查看 Timings 报告。

**推荐使用 `/paper timings paste` 命令生成 Timings 报告，方便在线查看和分享。**

**生成 Timings 报告步骤:**

1.  **启动 Paper 服务器。**
2.  **运行 `/paper timings on` 或 `/timings on` 命令启用 Timings 记录。**  启用 Timings 记录后，服务器将开始收集性能数据。
3.  **模拟服务器负载。**  在 Timings 记录期间，尽量模拟服务器的真实负载情况，例如让玩家进入服务器进行游戏，或运行压力测试工具。
4.  **运行 `/paper timings paste` 或 `/timings paste` 命令生成 Timings 报告。**  在 Timings 记录足够时间后 (例如 5-10 分钟)，运行此命令生成 Timings 报告。
5.  **复制并分享 Timings 报告 URL 链接。**  命令执行成功后，会返回一个 Timings 报告的 URL 链接，复制该链接并在浏览器中打开，即可在线查看 Timings 报告。

**Timings 报告 URL 示例:**

`https://timings.aikar.co/?id=xxxxxxxxxxxxxxxxxxxxxxxx`

## 分析 Timings 报告

打开 Timings 报告 URL 链接后，您将看到一个包含各种性能数据的 Web 页面。Timings 报告主要分为以下几个部分：

*   **Summary (摘要)**:  显示 Timings 报告的摘要信息，包括服务器版本、TPS、平均 Tick 耗时、CPU 使用率、内存使用率等。
*   **Cost by Category (按类别耗时)**:  按类别 (例如 `minecraft`, `plugin`, `tileentity`, `entity`) 显示服务器 Tick 耗时占比，帮助您快速定位性能瓶颈所在的大类。
*   **Cost by Plugin (按插件耗时)**:  按插件显示插件的 Tick 耗时占比，帮助您找出性能消耗较高的插件。
*   **Cost by TileEntity (按方块实体耗时)**:  按方块实体类型显示方块实体的 Tick 耗时占比，帮助您找出性能消耗较高的方块实体。
*   **Cost by Entity (按实体耗时)**:  按实体类型显示实体的 Tick 耗时占比，帮助您找出性能消耗较高的实体。
*   **Timeline (时间线)**:  以时间线图表的形式显示服务器 TPS 和 Tick 耗时变化趋势，帮助您了解服务器性能随时间的变化情况。
*   **Full Report (完整报告)**:  提供更详细的性能数据，包括每个方法的耗时、调用次数等。

**Timings 报告分析技巧:**

*   **关注 TPS 和 Tick 耗时:**  TPS (每秒 Tick 数) 是衡量服务器性能的重要指标。正常的 TPS 值为 20，如果 TPS 值低于 20，则表示服务器存在性能问题。Tick 耗时 (MSPT, 毫秒每 Tick) 是指服务器处理每个游戏 Tick 所需的时间。Tick 耗时越高，TPS 越低。关注 TPS 和 Tick 耗时可以帮助您快速判断服务器性能是否正常。
*   **查看 "Cost by Category" 部分:**  "Cost by Category" 部分可以帮助您快速定位性能瓶颈所在的大类。如果 `plugin` 类别的耗时占比过高，则说明性能瓶颈可能在插件方面。如果 `tileentity` 或 `entity` 类别的耗时占比过高，则说明性能瓶颈可能在方块实体或实体方面。
*   **查看 "Cost by Plugin", "Cost by TileEntity", "Cost by Entity" 部分:**  这些部分可以帮助您进一步定位到具体的性能消耗较高的插件、方块实体或实体类型。例如，如果您发现某个插件的耗时占比过高，可以尝试优化该插件的配置或更换为其他性能更好的插件。如果您发现某种方块实体或实体的耗时占比过高，可以尝试减少服务器中该类型方块实体或实体的数量。
*   **分析 "Timeline" 图表:**  "Timeline" 图表可以帮助您了解服务器性能随时间的变化情况。例如，如果 TPS 值在某个时间段内突然下降，可以结合其他性能数据分析该时间段内发生了什么，导致性能下降。
*   **查看 "Full Report" 部分 (高级分析):**  "Full Report" 部分提供了更详细的性能数据，包括每个方法的耗时、调用次数等。如果您是技术专家，可以深入分析 "Full Report" 部分，找出性能瓶颈的具体代码和方法。

**Timings 报告颜色说明:**

Timings 报告中使用不同的颜色来表示不同的耗时占比：

*   **绿色**:  低耗时 (通常低于 1%)
*   **黄色**:  中等耗时 (通常在 1%-5% 之间)
*   **橙色**:  较高耗时 (通常在 5%-10% 之间)
*   **红色**:  高耗时 (通常高于 10%)

**重点关注橙色和红色部分，这些部分通常指示了性能瓶颈所在。**

## Timings 报告分析示例

**示例 1: 插件耗时过高**

如果您在 "Cost by Category" 部分看到 `plugin` 类别为红色，并且在 "Cost by Plugin" 部分看到某个插件的耗时占比非常高 (例如超过 20%)，则说明该插件可能是服务器性能瓶颈。您可以尝试：

*   **优化插件配置:**  检查插件的配置文件，尝试调整插件的配置项，降低插件的性能消耗。
*   **更新插件版本:**  检查插件是否有新版本发布，更新到最新版本，新版本可能包含性能优化。
*   **更换插件:**  如果插件性能问题无法解决，可以考虑更换为其他功能类似的但性能更好的插件。
*   **移除插件:**  如果插件功能不是必需的，可以考虑移除该插件，以降低服务器负载。

**示例 2: 方块实体耗时过高**

如果您在 "Cost by Category" 部分看到 `tileentity` 类别为红色，并且在 "Cost by TileEntity" 部分看到某种方块实体 (例如 `minecraft:hopper`, `minecraft:furnace`) 的耗时占比非常高，则说明该类型方块实体可能是服务器性能瓶颈。您可以尝试：

*   **减少方块实体数量:**  减少服务器中该类型方块实体的数量。
*   **优化方块实体布局:**  优化方块实体的布局，减少不必要的方块实体交互。
*   **使用更高效的替代方案:**  寻找更高效的替代方案来替代该类型方块实体的功能。例如，使用水流或矿车替代漏斗进行物品传输。

**示例 3: 实体耗时过高**

如果您在 "Cost by Category" 部分看到 `entity` 类别为红色，并且在 "Cost by Entity" 部分看到某种实体类型 (例如 `minecraft:item`, `minecraft:creeper`) 的耗时占比非常高，则说明该类型实体可能是服务器性能瓶颈。您可以尝试：

*   **减少实体数量:**  减少服务器中该类型实体的数量。例如，清理地面上的掉落物 (物品实体), 限制怪物生成数量。
*   **优化实体生成机制:**  优化实体生成机制，避免短时间内生成大量实体。
*   **使用实体管理插件:**  使用实体管理插件来控制和优化实体行为。

## 注意事项

*   **Timings 报告会增加服务器的性能开销。**  在生产环境中，请不要长时间启用 Timings 记录，只在需要分析性能问题时启用 Timings 记录，并在分析完成后及时关闭 Timings 记录 (使用 `/paper timings off` 或 `/timings off` 命令)。
*   **Timings 报告数据是采样数据，并非 100% 精确。**  Timings 报告是通过采样的方式收集性能数据的，因此报告中的数据可能存在一定的误差。但 Timings 报告仍然可以有效地帮助您定位性能瓶颈。
*   **Timings 报告分析需要一定的经验和知识。**  性能报告中包含了大量的性能数据，需要您具备一定的 Minecraft 服务器性能优化知识才能正确理解和分析。如果您不熟悉 Timings 报告分析，可以参考相关的 Timings 报告分析教程和文档，或寻求专业人士的帮助。
*   **结合其他性能分析工具 (例如 Profiler) 和优化方法进行性能优化。**  Timings 报告可以帮助您快速了解服务器的整体性能概况，找出潜在的性能瓶颈。但要深入分析性能瓶颈的细节，并进行更精细的优化，可能还需要结合使用 Profiler 工具和其他性能优化方法。

如果您在使用 Timings 报告过程中遇到任何问题，请随时在 [PaperMC Discord](https://discord.gg/papermc) 的 `#paper-help` 频道中寻求帮助。 