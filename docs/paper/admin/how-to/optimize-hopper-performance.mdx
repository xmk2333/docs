---
slug: /optimize-hopper-performance
title: Hopper Performance Optimization
description: 如何优化漏斗性能以减少服务器负载。
---

# 漏斗性能优化

漏斗 (Hopper) 是 Minecraft 中常用的物品传输方块，但大量漏斗同时工作可能会对服务器性能造成较大影响。Paper 提供了一些配置选项，可以帮助您优化漏斗性能，减少服务器负载。

## 优化配置

以下是一些可以优化漏斗性能的 `paper.yml` 配置文件选项：

```yaml
config:
  hopper:
    enabled: true # 是否启用漏斗功能 (默认: true)
    transfer-search-range: 8 # 漏斗搜索物品传输目标的范围 (默认: 8)
    transfer-search-frequency: 8 # 漏斗搜索物品传输目标的频率 (ticks, 默认: 8)
    transfer-cooldown: 1 # 漏斗物品传输冷却时间 (ticks, 默认: 1)
    transfer-amount: 1 # 漏斗单次传输物品数量 (默认: 1)
    allow-block-entity-interactions: true # 是否允许漏斗与方块实体交互 (例如箱子, 熔炉等, 默认: true)
    allow-plugin-interactions: true # 是否允许插件控制漏斗行为 (默认: true)
```

**配置项说明:**

*   **`enabled`**: 是否启用漏斗功能。如果禁用，所有漏斗将停止工作。通常情况下不需要禁用漏斗功能，除非您想完全禁止使用漏斗。
*   **`transfer-search-range`**: 漏斗搜索物品传输目标的范围 (区块)。漏斗会定期搜索周围指定范围内的容器方块 (例如箱子、熔炉等) 或其他漏斗作为物品传输目标。减小此值可以减少漏斗的搜索范围，降低服务器负载，但也会限制漏斗的传输距离。默认值为 `8`，您可以尝试减小到 `4` 或 `6`。
*   **`transfer-search-frequency`**: 漏斗搜索物品传输目标的频率 (ticks)。漏斗每隔一定 ticks 会搜索一次物品传输目标。增大此值可以降低漏斗的搜索频率，降低服务器负载，但也会降低漏斗的物品传输速度。默认值为 `8`，您可以尝试增大到 `10` 或 `12`。
*   **`transfer-cooldown`**: 漏斗物品传输冷却时间 (ticks)。漏斗每次传输物品后，需要等待一定 ticks 才能再次传输。增大此值可以降低漏斗的物品传输频率，降低服务器负载，但也会降低漏斗的物品传输速度。默认值为 `1`，您可以尝试增大到 `2` 或 `3`。
*   **`transfer-amount`**: 漏斗单次传输物品数量。漏斗每次传输物品时，可以传输的物品数量。减小此值可以降低漏斗单次传输的物品数量，降低服务器负载，但也会降低漏斗的物品传输效率。默认值为 `1`，通常不建议修改此值。
*   **`allow-block-entity-interactions`**: 是否允许漏斗与方块实体交互 (例如箱子, 熔炉等)。如果禁用，漏斗将无法与箱子、熔炉等容器方块交互，只能与其他漏斗交互。禁用此项可以减少漏斗的功能，降低服务器负载，但也会限制漏斗的使用场景。默认值为 `true`，您可以根据需要禁用。
*   **`allow-plugin-interactions`**: 是否允许插件控制漏斗行为。如果禁用，插件将无法通过 API 控制漏斗的行为。禁用此项通常没有性能优化效果，除非某些插件大量使用漏斗 API 造成性能问题。默认值为 `true`，通常不需要修改。

**优化建议:**

*   **适当减小 `transfer-search-range`**:  根据您的服务器实际情况，适当减小漏斗的搜索范围，例如从 `8` 减小到 `6` 或 `4`。
*   **适当增大 `transfer-search-frequency`**:  根据您的服务器物品传输需求，适当增大漏斗的搜索频率，例如从 `8` 增大到 `10` 或 `12`。
*   **适当增大 `transfer-cooldown`**:  根据您的服务器物品传输速度需求，适当增大漏斗的传输冷却时间，例如从 `1` 增大到 `2` 或 `3`。
*   **谨慎禁用 `allow-block-entity-interactions`**:  如果您的服务器不需要漏斗与箱子、熔炉等容器方块交互，可以考虑禁用此项，以减少漏斗的功能和服务器负载。

**性能测试:**

修改漏斗配置后，建议您进行性能测试，观察服务器的 TPS 和 CPU 使用率变化，找到最佳的漏斗配置。您可以使用 `/paper timings report` 命令生成 timings 报告，分析漏斗相关的性能数据。

**其他优化方法:**

*   **减少漏斗使用数量:**  尽量减少服务器中漏斗的使用数量。可以使用其他物品传输方式 (例如水流、矿车) 替代部分漏斗的功能。
*   **优化漏斗布局:**  合理设计漏斗布局，减少不必要的漏斗搜索和物品传输。例如，避免将大量漏斗连接到同一个容器方块，避免使用过长的漏斗链。
*   **使用更高效的物品传输方案:**  对于大批量物品传输，可以考虑使用更高效的物品传输方案，例如 [Item Router](https://www.spigotmc.org/resources/item-router.74782/) 插件等。

**总结:**

通过合理配置 `paper.yml` 文件中的漏斗相关选项，并结合其他优化方法，您可以有效地优化漏斗性能，减少服务器负载，提升服务器的整体性能。请根据您的服务器实际情况进行测试和调整，找到最佳的漏斗配置方案。

如果您在优化漏斗性能过程中遇到任何问题，请随时在 [PaperMC Discord](https://discord.gg/papermc) 的 `#paper-help` 频道中寻求帮助。 